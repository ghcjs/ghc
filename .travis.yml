language: haskell
before_install:
  - sudo apt-get update -qq
  - sudo apt-get --no-install-recommends install darcs
  - apt-cache search java | awk '{print($1)}' | grep -E -e '^(ia32-)?(sun|oracle)-java' -e '^openjdk-' -e '^icedtea' -e '^(default|gcj)-j(re|dk)' -e '^gcj-(.*)-j(re|dk)' -e 'java-common' | xargs sudo apt-get -y remove
  - sudo apt-get -y autoremove
  - dpkg -l | grep ^rc | awk '{print($2)}' | xargs sudo apt-get -y purge
  - sudo apt-get clean
  - ./sync-all -r https://github.com/ghc get
  - ./sync-all -r https://github.com/ghcjs --ghcjs get
  - ./sync-all checkout ghc-7.6
  - ./unpack.sh
  - perl boot
  - ./configure --prefix=$HOME/ghcjs
install:
  - make -j2 stage=1 || make stage=1
  - make -j2 || make
script:
  - make -j2 stage=3 || make stage=3
  - cp inplace/lib/ghc-stage3 inplace/lib/ghc-stage1
  - cp inplace/lib/ghc-stage3 inplace/lib/ghc-stage2
  - cp ghc/stage3/build/tmp/ghc-stage3 ghc/stage2/build/tmp/ghc-stage2

  - rm -rf compiler/stage2
  - rm -rf libraries/*/dist-install
  - rm -rf libraries/*/*/dist-install
  - make -j5 || make

  - cp inplace/lib/ghc-stage3 inplace/lib/ghc-stage2
  - cp ghc/stage3/build/tmp/ghc-stage3 ghc/stage2/build/tmp/ghc-stage2

  - rm -rf libraries/haskell98/dist-install
  - rm -rf libraries/haskell2010/dist-install
  - make -j5 || make

  - make install

  - export PATH=$HOME/ghcjs/bin:$PATH
  - hash -r

  - rm $HOME/ghcjs/bin/cabal || true  

notifications:
  irc:
    channels: "irc.freenode.net#ghcjs"
  email: true
