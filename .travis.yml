language: haskell
before_install:
  - sudo apt-get update -qq
  - sudo apt-get --no-install-recommends install darcs
  - sudo apt-get build-dep ghc
  - apt-cache search java | awk '{print($1)}' | grep -E -e '^(ia32-)?(sun|oracle)-java' -e '^openjdk-' -e '^icedtea' -e '^(default|gcj)-j(re|dk)' -e '^gcj-(.*)-j(re|dk)' -e 'java-common' | xargs sudo apt-get -y remove
  - sudo apt-get -y autoremove
  - dpkg -l | grep ^rc | awk '{print($2)}' | xargs sudo apt-get -y purge
  - sudo apt-get clean
  - ./sync-all -r https://github.com/ghc get
  - ./sync-all -r https://github.com/ghcjs --ghcjs get
  - ./sync-all checkout ghc-7.6
  - ./unpack.sh
  - perl boot
  - ./configure --prefix=$HOME/ghcjs
  - make -j2 stage=0 || true
  - make -j2 stage=1 || true
install:
  - make -j2 || make
script:
  - make -j2 stage=3 || make stage=3
  - cp inplace/lib/ghc-stage3 inplace/lib/ghc-stage1
  - cp inplace/lib/ghc-stage3 inplace/lib/ghc-stage2
  - cp ghc/stage3/build/tmp/ghc-stage3 ghc/stage2/build/tmp/ghc-stage2

  - rm -rf compiler/stage2
  - rm -rf libraries/*/dist-install
  - rm -rf libraries/*/*/dist-install
  - make -j5 || make

  - cp inplace/lib/ghc-stage3 inplace/lib/ghc-stage2
  - cp ghc/stage3/build/tmp/ghc-stage3 ghc/stage2/build/tmp/ghc-stage2

  - rm -rf libraries/haskell98/dist-install
  - rm -rf libraries/haskell2010/dist-install
  - make -j5 || make

  - make install

  - export PATH=$HOME/ghcjs/bin:$PATH
  - cabal install cabal-install --prefix=$HOME/ghcjs
  - hash -r
  - ghc-pkg unregister HTTP
  - ghc-pkg unregister network
  - ghc-pkg unregister parsec
  - ghc-pkg unregister mtl
  - ghc-pkg unregister transformers
  - ghc-pkg unregister zlib
  - ghc-pkg unregister random
  - ghc-pkg unregister text

  - cabal install cabal-meta cabal-src --prefix=$HOME/ghcjs

  - cd libraries/ghcjs
  - cabal-meta install -f-compiler-only -fgen2 -ftrampoline -fplain

  - cd ../..
  - ghcjs-boot

notifications:
  irc:
    channels: "irc.freenode.net#ghcjs"
  email: true
